<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Coach Controller</title>
  <style>
    body {
      background: #000;
      color: white;
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .main-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      width: 100%;
      box-sizing: border-box;
    }

    h1 {
      margin-top: 0;
      font-size: 2rem;
    }

    .tab-button {
      background-color: #333;
      border: none;
      color: white;
      padding: 15px 32px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 4px 2px;
      cursor: pointer;
      border-radius: 8px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      padding: 20px;
      font-size: 2rem;
    }

    .workout-name {
      background: #fcd34d; /* yellow-400 */
      color: #1f2937; /* gray-800 */
      margin: 50px auto 10px;
      padding: 30px 15px;
      width: 90%;
      max-width: 500px;
      font-size: 2.5rem;
      font-weight: bold;
      border-radius: 20px;
      box-sizing: border-box;
      word-wrap: break-word;
    }

    .timer-box {
      background: #111827; /* gray-900 */
      color: white;
      margin: 20px auto;
      padding: 20px;
      width: 180px;
      font-size: 3rem;
      border-radius: 10px;
    }

    .next {
      color: #9ca3af; /* gray-400 */
      font-size: 1rem;
    }

    .controls {
      margin-top: 40px;
    }
    
    .control-group {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    input, button, select {
      font-size: 1rem;
      padding: 10px;
      margin: 5px;
      border-radius: 8px;
      box-sizing: border-box;
    }

    .multi-part-controls {
      background: #1f2937;
      padding: 20px;
      border-radius: 10px;
      margin: 20px auto;
      max-width: 600px;
    }

    .part-section {
      border: 1px solid #4b5563;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
    }
    
    .part-section h2 {
      margin-top: 0;
      color: #fcd34d;
    }

    .pin-controls {
        margin-top: 20px;
        display: flex;
        justify-content: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    .pin-controls button {
        border: 2px solid #6366f1; /* indigo-500 */
        color: #6366f1;
    }

    .pin-controls .active {
        background-color: #6366f1;
        color: white;
    }
    
    .control-group span {
      display: flex;
      align-items: center;
      gap: 5px;
      color: #d1d5db; /* gray-300 */
    }

    .workout-inputs {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin: 20px 0;
    }

    .workout-row {
      background: #111827; /* gray-900 */
      padding: 10px;
      border-radius: 8px;
      display: flex;
      gap: 10px;
      align-items: center;
      width: 90%;
      max-width: 600px;
      box-sizing: border-box;
      flex-wrap: wrap;
    }

    .remove-btn {
      background: none;
      color: white;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
    }

    button {
      background: none;
      padding: 10px 20px;
      font-size: 1rem;
      cursor: pointer;
    }

    .start-btn {
      border: 2px solid #fcd34d; /* yellow-400 */
      color: #fcd34d;
    }

    .reset-btn {
      border: 2px solid #ef4444; /* red-500 */
      color: #ef4444;
    }

    .skip-btn {
      border: 2px solid #9ca3af; /* gray-400 */
      color: #9ca3af;
    }

    .add-btn {
      color: white;
      border: 2px solid white;
    }
    
    .save-part-btn {
      color: #fcd34d;
      border: 2px solid #fcd34d;
      margin-top: 10px;
    }
    
    .send-btn {
      color: white;
      border: 2px solid #3b82f6; /* blue-500 */
      margin-top: 10px;
    }

    .workout-row input {
      font-size: 1rem;
      padding: 10px;
      border: none;
      background: #1f2937; /* gray-800 */
      color: white;
      border-radius: 5px;
    }

    .wname {
      flex: 3;
      min-width: 150px;
    }
    
    .wtime {
      flex: 1;
      min-width: 80px;
    }

    .workout-row input::placeholder {
      color: #6b7280; /* gray-500 */
      font-style: italic;
    }
    
    @media (max-width: 600px) {
      .workout-name {
        font-size: 2rem;
        padding: 20px 10px;
      }
      
      .timer-box {
        font-size: 2rem;
        width: 150px;
      }
      
      h1 {
        font-size: 1.5rem;
      }

      .tab-button {
        font-size: 14px;
        padding: 10px 20px;
      }
      
      .control-group {
        flex-direction: column;
        align-items: center;
        gap: 5px;
      }
      
      .workout-row {
        flex-direction: column;
        gap: 5px;
        align-items: stretch;
      }
      
      .workout-row input {
        width: 100%;
        text-align: center;
      }
      
      .wname, .wtime {
        flex: none;
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <h1>Coach Controller</h1>
    <button class="tab-button" onclick="window.open('athlete.html', '_blank')">Open Athlete View</button>

    <div id="rounds">Rounds Left: 0</div>
    <div id="timerBox" class="timer-box">00:00</div>

    <div id="workoutName" class="workout-name">Ready</div>
    <div class="next" id="nextWorkout">Next: -</div>

    <div class="controls">
      <div class="control-group">
        <span>Prepare Time (sec): <input type="number" id="prepareTime" value="0" min="1"/></span>
        <span>Rounds: <input type="number" id="roundsInput" value="1" min="1"/></span>
      </div>
      
      <div class="control-group">
        <button onclick="startWorkout()" class="start-btn">‚ñ∂ START</button>
        <button onclick="resetWorkout()" class="reset-btn"> RESET</button>
        <button onclick="skipWorkout()" class="skip-btn">‚è≠ SKIP</button>
      </div>
    </div>

    <div class="multi-part-controls">
        <p>Select which workout part you want to show on the Athlete View:</p>
        <div class="pin-controls" id="pin-controls">
            <button onclick="setActivePart('A')" id="pin-A">Part A</button>
            <button onclick="setActivePart('B')" id="pin-B">Part B</button>
            <button onclick="setActivePart('C')" id="pin-C">Part C</button>
        </div>
        <hr style="margin: 20px 0; border-color: #4b5563;">

        <!-- Part A Section -->
        <div class="part-section" id="partA-section">
            <h2>Part A Workout</h2>
            <div class="workout-inputs" id="workoutInputsA"></div>
            <div class="flex-row">
              <button onclick="addWorkout('A')" class="add-btn">‚ûï Add Workout to Part A</button>
              <button onclick="savePartWorkouts('A')" class="save-part-btn">Save Part A</button>
            </div>
        </div>

        <!-- Part B Section -->
        <div class="part-section" id="partB-section">
            <h2>Part B Workout</h2>
            <div class="workout-inputs" id="workoutInputsB"></div>
            <div class="flex-row">
              <button onclick="addWorkout('B')" class="add-btn">‚ûï Add Workout to Part B</button>
              <button onclick="savePartWorkouts('B')" class="save-part-btn">Save Part B</button>
            </div>
        </div>

        <!-- Part C Section -->
        <div class="part-section" id="partC-section">
            <h2>Part C Workout</h2>
            <div class="workout-inputs" id="workoutInputsC"></div>
            <div class="flex-row">
              <button onclick="addWorkout('C')" class="add-btn">‚ûï Add Workout to Part C</button>
              <button onclick="savePartWorkouts('C')" class="save-part-btn">Save Part C</button>
            </div>
        </div>

        <button onclick="sendToAthleteView()" class="send-btn">Sent to Athlete view</button>
    </div>
  </div>

  <audio id="tick" src="https://actions.google.com/sounds/v1/household/clock_ticking.ogg"></audio>
  <audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

  <script>
    // Global state object to hold all workout data
    let appState = {
        workouts: {
            A: [],
            B: [],
            C: []
        },
        activePart: 'A',
        currentIndex: -1,
        roundCount: 0,
        totalRounds: 1,
        timer: 0,
        started: false,
        currentWorkoutName: 'Ready',
        nextWorkoutName: 'Next: -',
        roundsLeftText: 'Rounds Left: 0',
        timerBoxText: '00:00'
    };

    const tickSound = document.getElementById("tick");
    const beepSound = document.getElementById("beep");
    let interval = null;
    let nextVoiceScheduled = false;

    // This function saves the entire app state to local storage
    function saveState() {
      // Update state with current UI values before saving
      appState.totalRounds = parseInt(document.getElementById("roundsInput").value) || 1;
      appState.currentWorkoutName = document.getElementById("workoutName").textContent;
      appState.nextWorkoutName = document.getElementById("nextWorkout").textContent;
      appState.roundsLeftText = document.getElementById("rounds").textContent;
      appState.timerBoxText = document.getElementById("timerBox").textContent;
      
      // Save the state to local storage
      localStorage.setItem('workoutState', JSON.stringify(appState));
      console.log('State saved:', appState);
    }
    
    // Function to handle the "Sent to Athlete view" button click
    function sendToAthleteView() {
      // First, save the currently active part's workouts
      savePartWorkouts(appState.activePart);
      // Then, save the entire state to push the update to the Athlete view
      saveState();
      alert("Workout sent to Athlete View!");
    }
    
    // Function to save only the currently active part's workouts
    function savePartWorkouts(part) {
        appState.workouts[part] = gatherWorkoutsFromDOM(part);
        saveState();
    }

    function gatherWorkoutsFromDOM(part) {
        const workoutInputs = document.getElementById(`workoutInputs${part}`);
        const names = workoutInputs.querySelectorAll(".wname");
        const times = workoutInputs.querySelectorAll(".wtime");
        let tempWorkoutQueue = [];
        for (let i = 0; i < names.length; i++) {
            const name = names[i].value.trim();
            const time = parseInt(times[i].value.trim());
            if (name && !isNaN(time) && time > 0) {
                tempWorkoutQueue.push({ name, time });
            }
        }
        return tempWorkoutQueue;
    }

    // This function loads the state from local storage when the page is loaded
    function loadState() {
      const state = JSON.parse(localStorage.getItem('workoutState'));
      if (state) {
        appState = state;
        
        // Rebuild the workout inputs based on the saved workoutQueue
        document.getElementById("workoutInputsA").innerHTML = '';
        state.workouts.A.forEach(workout => addWorkout('A', workout.name, workout.time));
        if (state.workouts.A.length === 0) addWorkout('A');
        
        document.getElementById("workoutInputsB").innerHTML = '';
        state.workouts.B.forEach(workout => addWorkout('B', workout.name, workout.time));
        if (state.workouts.B.length === 0) addWorkout('B');

        document.getElementById("workoutInputsC").innerHTML = '';
        state.workouts.C.forEach(workout => addWorkout('C', workout.name, workout.time));
        if (state.workouts.C.length === 0) addWorkout('C');

        document.getElementById("prepareTime").value = state.prepareTime || '0';
        document.getElementById("roundsInput").value = state.totalRounds;

        // Update the UI based on the loaded state
        document.getElementById("workoutName").textContent = state.currentWorkoutName;
        document.getElementById("nextWorkout").textContent = state.nextWorkoutName;
        document.getElementById("rounds").textContent = state.roundsLeftText;
        document.getElementById("timerBox").textContent = state.timerBoxText;

        // Set the active part buttons and display the correct section
        setActivePart(state.activePart);
      } else {
        // If no state exists, initialize with a single row for each part
        addWorkout('A');
        addWorkout('B');
        addWorkout('C');
        setActivePart('A');
      }
    }

    // Function to set the active part to be displayed on the Athlete View
    function setActivePart(part) {
        appState.activePart = part;
        const buttons = document.querySelectorAll('.pin-controls button');
        buttons.forEach(button => button.classList.remove('active'));
        document.getElementById(`pin-${part}`).classList.add('active');

        // Show/Hide the correct workout section
        document.getElementById('partA-section').style.display = 'none';
        document.getElementById('partB-section').style.display = 'none';
        document.getElementById('partC-section').style.display = 'none';
        document.getElementById(`part${part}-section`).style.display = 'block';
        
        saveState();
    }

    // This function adds a new workout row to the page
    function addWorkout(part, name = "", time = "") {
      const workoutInputs = document.getElementById(`workoutInputs${part}`);
      const div = document.createElement("div");
      div.className = "workout-row";
      div.innerHTML = `
        <input type="text" value="${name}" class="wname" placeholder="WORKOUT NAME (Max 30 words)" oninput="limitWords(this, 30)" maxlength="300"/>
        : 
        <input type="number" value="${time}" class="wtime" min="1" placeholder="Time (sec)"/>
        <button class="remove-btn" onclick="this.parentElement.remove(); savePartWorkouts('${part}')">‚ùå</button>
      `;
      workoutInputs.appendChild(div);
    }
    
    // This is the updated startWorkout function. It now always resets the state before starting.
    function startWorkout() {
      // Clear any existing timer to prevent multiple timers running at once
      clearInterval(interval);
      // Reset state variables to ensure a fresh start
      appState.currentIndex = -1;
      appState.roundCount = 0;
      appState.timer = 0;
      appState.started = true;
      appState.workoutQueue = appState.workouts[appState.activePart];

      if (appState.workoutQueue.length === 0) {
        console.error("Please add at least one workout with a valid time.");
        return;
      }

      appState.totalRounds = parseInt(document.getElementById("roundsInput").value) || 1;
      appState.roundCount = appState.totalRounds;

      const prepareTime = parseInt(document.getElementById("prepareTime").value) || 10;
      if (prepareTime > 0) {
        appState.workoutQueue.unshift({ name: "Prepare", time: prepareTime });
      }

      appState.currentIndex = 0;
      saveState();
      runNextWorkout();
    }

    // This function runs the next workout in the queue
    function runNextWorkout() {
      nextVoiceScheduled = false;

      if (appState.currentIndex >= appState.workoutQueue.length) {
        appState.roundCount--;
        if (appState.roundCount <= 0) {
          showDone();
          return;
        } else {
          appState.currentIndex = 0;
        }
      }

      const current = appState.workoutQueue[appState.currentIndex];
      const next = appState.workoutQueue[appState.currentIndex + 1];
      document.getElementById("workoutName").textContent = current.name;

      if (next) {
        document.getElementById("nextWorkout").textContent = `Next: ${next.name}`;
      } else if (appState.roundCount > 1) {
        document.getElementById("nextWorkout").textContent = `Next: ${appState.workoutQueue[0].name}`;
      } else {
        document.getElementById("nextWorkout").textContent = "Next: Workout Done";
      }

      document.getElementById("rounds").textContent = `Rounds Left: ${appState.roundCount}`;
      appState.timer = current.time;
      updateTimerDisplay();
      saveState();

      if (interval) clearInterval(interval);
      interval = setInterval(() => {
        appState.timer--;
        updateTimerDisplay();
        playTick();

        if (appState.timer <= 0) {
          clearInterval(interval);
          playBeep();
          
          if (appState.currentIndex === appState.workoutQueue.length - 1 && appState.roundCount === 1) {
            speakNow("Workout complete");
          } else {
            speakNow("Next");
          }
          
          appState.currentIndex++;
          saveState();
          runNextWorkout();
        } else if (appState.timer <= 5 && appState.timer > 0) {
          speakCountdown(appState.timer);
        } else if (appState.timer > 8 && appState.timer <= 13 && !nextVoiceScheduled) {
          const nextWorkoutName = (appState.currentIndex + 1 < appState.workoutQueue.length) ? appState.workoutQueue[appState.currentIndex + 1].name : "the next round";
          speakNow(` ${current.name}`);
          nextVoiceScheduled = true;
        }
        saveState();
      }, 1000);
    }

    // This function skips the current workout
    function skipWorkout() {
      if (!appState.started || appState.currentIndex >= appState.workoutQueue.length) return;
      clearInterval(interval);
      
      if (appState.currentIndex === appState.workoutQueue.length - 1 && appState.roundCount === 1) {
        speakNow("Workout complete");
      } else {
        speakNow("Next");
      }
      
      playBeep();
      appState.currentIndex++;
      saveState();
      runNextWorkout();
    }

    // This is the reset function that clears all data and provides a fresh start
    function resetWorkout() {
      clearInterval(interval);
      
      appState = {
        workouts: { A: [], B: [], C: [] },
        activePart: 'A',
        currentIndex: -1,
        roundCount: 0,
        totalRounds: 1,
        timer: 0,
        started: false,
        currentWorkoutName: 'Ready',
        nextWorkoutName: 'Next: -',
        roundsLeftText: 'Rounds Left: 0',
        timerBoxText: '00:00'
      };

      document.getElementById("workoutName").textContent = "Ready";
      document.getElementById("nextWorkout").textContent = "Next: -";
      document.getElementById("timerBox").textContent = "00:00";
      document.getElementById("rounds").textContent = "Rounds Left: 0";
      
      // Clear local storage
      localStorage.removeItem('workoutState');
      
      // Clear the workout rows from the page and re-add initial rows
      document.getElementById("workoutInputsA").innerHTML = '';
      document.getElementById("workoutInputsB").innerHTML = '';
      document.getElementById("workoutInputsC").innerHTML = '';
      
      addWorkout("A");
      addWorkout("B");
      addWorkout("C");
      setActivePart('A');
    }

    // This function is called when the entire workout is complete
    function showDone() {
      document.getElementById("workoutName").textContent = "üéâ Workout Complete!";
      document.getElementById("nextWorkout").textContent = "";
      document.getElementById("timerBox").textContent = "00:00";
      appState.started = false; // Set started to false
      saveState(); // Save the state to notify the Athlete View
    }

    // This function updates the timer display
    function updateTimerDisplay() {
      const min = String(Math.floor(appState.timer / 60)).padStart(2, '0');
      const sec = String(appState.timer % 60).padStart(2, '0');
      document.getElementById("timerBox").textContent = `${min}:${sec}`;
    }

    // This function plays a tick sound
    function playTick() {
      tickSound.currentTime = 0;
      tickSound.volume = 1.0;
      tickSound.play();
    }

    // This function plays a beep sound
    function playBeep() {
      beepSound.currentTime = 0;
      beepSound.volume = 1.0;
      beepSound.play();
    }

    // This function speaks the countdown numbers
    function speakCountdown(t) {
      const utter = new SpeechSynthesisUtterance(`${t}`);
      utter.rate = 1.2;
      speechSynthesis.speak(utter);
    }

    // This function speaks a message
    function speakNow(message) {
      const utter = new SpeechSynthesisUtterance(message);
      utter.rate = 0.9;
      speechSynthesis.speak(utter);
    }

    // New function to limit the number of words in an input field
    function limitWords(input, maxWords) {
      const words = input.value.split(/\s+/).filter(word => word.length > 0);
      if (words.length > maxWords) {
        input.value = words.slice(0, maxWords).join(" ");
      }
    }
    
    // Add a helper function for the flex-row class
    const style = document.createElement('style');
    style.textContent = `
      .flex-row {
        display: flex;
        justify-content: center;
        gap: 10px;
        flex-wrap: wrap;
      }
    `;
    document.head.appendChild(style);

    // Initial setup
    loadState();
    // After loading state, make sure the active part's section is shown
    setActivePart(appState.activePart);
    
  </script>
</body>
</html>
